<ul class="chapter-tree level-{{ level|default:0 }}">
  {% for node in nodes %}
    {% with chapter=node.chapter children=node.children %}
      {% with has_children=children|length %}
        <li class="chapter-tree-node">

          <div class="chapter-tree-node-inner">
            <div class="chapter-node-pill chapter-pill--with-toggle">

              {% if has_children %}
                <button
                  type="button"
                  class="chapter-toggle"
                  id="chapter-toggle-{{ chapter.id }}"
                  onclick="toggleChapterChildren('{{ chapter.id }}')"
                  aria-controls="children-{{ chapter.id }}"
                  aria-expanded="{% if level|default:0 == 0 and forloop.first %}true{% else %}false{% endif %}"
                >
                  ▸
                  <span class="sr-only">
                    Toggle children of chapter {{ chapter.ordinal }}
                  </span>
                </button>
              {% else %}
                <span class="chapter-toggle-spacer"></span>
              {% endif %}

              <div class="chapter-pill-text">
                <div class="chapter-pill-title-row">
                  <a
                    href="{% url 'feathertree:chapter_view' chapter.id %}"
                    class="chapter-link-title"
                  >
                    {{ chapter.title|default:"Untitled" }}
                  </a>
                </div>

                <div class="chapter-meta">
                  {{ chapter.author.display_name|default:chapter.author.username }}
                  {% if chapter.timestamp %}
                    · {{ chapter.timestamp|date:"M j, Y" }}
                  {% endif %}
                </div>
              </div>

            </div>
          </div>

          {% if has_children %}
            <ul
              id="children-{{ chapter.id }}"
              class="chapter-children {% if level|default:0 == 0 and forloop.first %}is-expanded{% else %}is-collapsed{% endif %}"
            >
              {% include "feathertree/_chapter_tree.html" with nodes=children level=level|default:0|add:"1" only %}
            </ul>
          {% endif %}

        </li>
      {% endwith %}
    {% endwith %}
  {% endfor %}
</ul>
