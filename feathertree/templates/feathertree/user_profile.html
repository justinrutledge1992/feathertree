{% extends "feathertree/base.html" %}

{% block head %}
{% load static %}
<title>Feathertree ⋅ {{ profile_user.display_name }}</title>
<meta name="description" content="">
<meta name="keywords" content="">
{% endblock head %}

{% block body %}
{% include "feathertree/_header.html" %}

<div class="profile content">
    <h4>{{ profile_user.display_name }}'s Feathertree</h4>
    <h5>Stories & Chapters</h5>

    {% regroup chapters by story as story_groups %}

    {% if story_groups %}
        {% for group in story_groups %}
            <div class="story-group">
                <div class="story-header" onclick="toggleChapters('{{ group.grouper.id }}')" role="button" tabindex="0" aria-controls="chapters-{{ group.grouper.id }}" aria-expanded="false">
                    <span>{{ group.grouper.title }}</span>
                    <span>({{ group.list|length }} chapter{{ group.list|length|pluralize }})</span>
                </div>
                <ul id="chapters-{{ group.grouper.id }}" class="chapter-list">
                    {% for chapter in group.list %}
                        <li>
                            <a href="{% url 'feathertree:chapter_view' chapter.id %}">
                                Chapter {{ chapter.ordinal }}:
                                {{ chapter.title|default:"Untitled" }}
                            </a>
                            <small>· {{ chapter.timestamp|date:"F j, Y" }}</small>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    {% else %}
        <p><em>No chapters yet.</em></p>
    {% endif %}
</div>

<script>
function toggleChapters(storyId) {
    const list = document.getElementById(`chapters-${storyId}`);
    const opened = list.classList.toggle("open");
    const header = list?.previousElementSibling;
    if (header) header.setAttribute('aria-expanded', opened ? 'true' : 'false');
}
</script>

{% endblock body %}
